<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document - <%= document.documentName %></title>
    <link rel="stylesheet" href="/styles/main.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/images/logo/favicon.png">
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <header>
        <%- include('../partials/header') %>
    </header>
    <main id="stock">
        <div class="stockHead">
           <h1>Document - <%= document.documentName %></h1> 
           <button class="createBtn" type="button" onclick="document.getElementById('createStockPopover').showModal()">
        </div>
        
        <!-- Filter and Search Form -->
        <form class="filter-search-form" action="/document/<%= document._id %>/stock" method="GET">
            <div class="form-group">
                <label for="categoryFilter">Filter by Category:</label>
                <select name="category" id="categoryFilter" onchange="this.form.submit()">
                    <option value="" <%= selectedCategory === '' ? 'selected' : '' %>>All</option>
                    <option value="Tools" <%= selectedCategory === 'Tools' ? 'selected' : '' %>>Tools</option>
                    <option value="Sundries" <%= selectedCategory === 'Sundries' ? 'selected' : '' %>>Sundries</option>
                    <option value="Chemicals" <%= selectedCategory === 'Chemicals' ? 'selected' : '' %>>Chemicals</option>
                    <option value="Hardware" <%= selectedCategory === 'Hardware' ? 'selected' : '' %>>Hardware</option>
                    <option value="Misc" <%= selectedCategory === 'Misc' ? 'selected' : '' %>>Misc</option>
                </select>
            </div>
            <div class="form-group">
                <label for="searchQuery">Search:</label>
                <input type="search" id="searchQuery" name="searchQuery" value="<%= searchQuery %>" placeholder="Name, Code, or Barcode...">
            </div>
            <button type="submit">Apply</button>
        </form>

        <% if (stock && stock.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="selectAllCheckbox" title="Select all on this page">
                        </th>
                        <th>Product Image</th>
                        <th>Product Name</th>
                        <th>Product Code</th>
                        <th>Brand</th>
                        <th>Category</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Barcode</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% stock.forEach(function(item) { %>
                        <tr id="item-<%= item.barcode %>">
                            <td>
                                <input type="checkbox" class="item-checkbox" value="<%= item.barcode %>">
                            </td>
                            <td><img src="<%= item.imageUrl || 'https://placehold.co/100x80/eee/ccc?text=No+Image' %>" alt="Product Image" style="width: 80px; height: auto; border-radius: 4px;"></td>
                            <td><%= item.productName %></td>
                            <td><%= item.productCode %></td>
                            <td><%= item.brand %></td>
                            <td><%= item.category %></td>
                            <td><%= item.qty %></td>
                            <td>Â£<%= item.price %></td>
                            <td><%= item.barcode %></td>
                            <td class="action-buttons">
                                <button class="editBtn" type="button" data-item='<%- JSON.stringify(item) %>'>
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button class="delBtn" type="button" onclick="deleteItem('<%= item.barcode %>', '<%= document._id %>')">
                                    <span class="material-symbols-outlined">delete</span>
                                </button> 
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <div class="no-stock-message">
                <h3>No Stock Found</h3>
                <p>There are no items that match your search or filter.</p>
            </div>
        <% } %>

        <!-- This form is now only for submitting the final selection -->
        <form id="viewSelectedForm" action="/selected" method="POST" style="margin-top: 20px;">
            <input type="hidden" name="documentId" value="<%= document._id %>">
            <!-- This container will be populated with hidden inputs by JavaScript -->
            <div id="selectedBarcodesContainer"></div>
            <button type="submit" class="selectBtn">View Selected (<span id="selected-count">0</span>)</button>
        </form>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
            <div class="pagination">
                <% for(let i = 1; i <= totalPages; i++) { %>
                    <a href="/document/<%= document._id %>/stock?page=<%= i %>&category=<%= selectedCategory %>&searchQuery=<%= searchQuery %>" class="<%= currentPage === i ? 'active' : '' %>">
                        <%= i %>
                    </a>
                <% } %>
            </div>
        <% } %>

    </main>

    <!-- Pop-up Dialogs -->
    <dialog id="createStockPopover">
        <form action="/addStock" method="POST" enctype="multipart/form-data">
            <h2>Create New Stock</h2>
            <input type="hidden" name="documentId" value="<%= document._id %>">
            
            <label for="image">Product Image</label>
            <input type="file" name="image" accept="image/*" capture="camera" />

            <label for="productName">Product Name</label>
            <input type="text" name="productName" maxlength="35" placeholder="Product Name" required>
            
            <label for="productCode">Product Code</label>
            <input type="text" name="productCode" placeholder="Product Code">
            
            <label for="Brand">Brand</label>
            <input type="text" name="Brand" placeholder="Brand">
            
            <label for="Category">Category</label>
            <select name="Category">
                <option value="Tools">Tools</option>
                <option value="Sundries">Sundries</option>
                <option value="Chemicals">Chemicals</option>
                <option value="Hardware">Hardware</option>
                <option value="Misc">Misc</option>
            </select>
            
            <label for="Qty">Quantity</label>
            <input type="number" name="Qty" placeholder="Qty" required>
            
            <label for="RRP">RRP</label>
            <input type="text" name="RRP" placeholder="e.g., 19.99">
            
            <label for="Price">Price</label>
            <input type="text" name="Price" placeholder="e.g., 15.50" required>
            
            <label for="Barcode">Barcode</label>
            <input type="text" name="Barcode" placeholder="Barcode" required>

            <div class="dialog-buttons">
                <button type="submit">Add Stock</button>
                <button type="button" onclick="document.getElementById('createStockPopover').close()">
            </div>
        </form>
    </dialog>

    <dialog id="editStockDialog">
        <form action="/updateStock" method="POST" enctype="multipart/form-data">
            <h2>Edit Stock Item</h2>
            <input type="hidden" name="originalBarcode">
            <input type="hidden" name="documentId" value="<%= document._id %>">
            <input type="hidden" name="currentPage" value="<%= currentPage %>">

            <div>
                <label>Current Image</label>
                <img id="current-image-preview" src="" alt="Current product image" style="max-width: 100px; margin-top: 5px; border-radius: 4px;">
            </div>
            
            <label for="image">Upload New Image (Optional)</label>
            <input type="file" name="image" accept="image/*" capture="camera" />

            <label for="productName">Product Name</label>
            <input type="text" name="productName" maxlength="35" placeholder="Product Name" required>
            
            <label for="productCode">Product Code</label>
            <input type="text" name="productCode" placeholder="Product Code">
            
            <label for="Brand">Brand</label>
            <input type="text" name="Brand" placeholder="Brand">
            
            <label for="Category">Category</label>
            <select name="Category">
                <option value="Tools">Tools</option>
                <option value="Sundries">Sundries</option>
                <option value="Chemicals">Chemicals</option>
                <option value="Hardware">Hardware</option>
                <option value="Misc">Misc</option>
            </select>
            
            <label for="Qty">Quantity</label>
            <input type="number" name="Qty" placeholder="Qty" required>
            
            <label for="RRP">RRP</label>
            <input type="text" name="RRP" placeholder="e.g., 19.99">
            
            <label for="Price">Price</label>
            <input type="text" name="Price" placeholder="e.g., 15.50" required>
            
            <label for="Barcode">Barcode</label>
            <input type="text" name="Barcode" placeholder="Barcode" required>

            <div class="dialog-buttons">
                <button type="submit">Save Changes</button>
                <button type="button" onclick="document.getElementById('editStockDialog').close()">Cancel</button>
            </div>
        </form>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SESSION_STORAGE_KEY = `selectedBarcodes_<%= document._id %>`;
            
            // --- STATE MANAGEMENT ---
            let selectedBarcodes = new Set(JSON.parse(sessionStorage.getItem(SESSION_STORAGE_KEY)) || []);

            const selectedCountSpan = document.getElementById('selected-count');
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const viewSelectedForm = document.getElementById('viewSelectedForm');
            const selectedBarcodesContainer = document.getElementById('selectedBarcodesContainer');
            const editButtons = document.querySelectorAll('.editBtn');

            // --- FUNCTIONS ---
            function updateSelection() {
                sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(Array.from(selectedBarcodes)));
                selectedCountSpan.textContent = selectedBarcodes.size;
            }

            function syncCheckboxes() {
                let allOnPageSelected = true;
                itemCheckboxes.forEach(checkbox => {
                    if (selectedBarcodes.has(checkbox.value)) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                        allOnPageSelected = false;
                    }
                });
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = itemCheckboxes.length > 0 && allOnPageSelected;
                }
                updateSelection();
            }

            // --- EVENT LISTENERS ---
            itemCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedBarcodes.add(checkbox.value);
                    } else {
                        selectedBarcodes.delete(checkbox.value);
                    }
                    syncCheckboxes();
                });
            });

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                    itemCheckboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                        if (selectAllCheckbox.checked) {
                            selectedBarcodes.add(checkbox.value);
                        } else {
                            selectedBarcodes.delete(checkbox.value);
                        }
                    });
                    updateSelection();
                });
            }
            
            viewSelectedForm.addEventListener('submit', (e) => {
                selectedBarcodesContainer.innerHTML = '';
                selectedBarcodes.forEach(barcode => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selectedBarcodes[]';
                    input.value = barcode;
                    selectedBarcodesContainer.appendChild(input);
                });

                if (selectedBarcodes.size === 0) {
                    e.preventDefault();
                    alert('Please select at least one item to view.');
                }
            });

            editButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const itemData = JSON.parse(button.dataset.item);
                    editItem(itemData);
                });
            });

            // --- INITIALIZATION ---
            syncCheckboxes();
        });
        
        // Your existing deleteItem and editItem functions
        function deleteItem(barcode, documentId) {
             if(confirm('Are you sure you want to delete this item?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/delete';
                form.style.display = 'none';

                const barcodeInput = document.createElement('input');
                barcodeInput.name = 'barcode';
                barcodeInput.value = barcode;
                form.appendChild(barcodeInput);

                const docIdInput = document.createElement('input');
                docIdInput.name = 'documentId';
                docIdInput.value = documentId;
                form.appendChild(docIdInput);

                document.body.appendChild(form);
                form.submit();
            }
        }
        
        function editItem(itemData) {
            const dialog = document.getElementById('editStockDialog');
            const form = dialog.querySelector('form');
            form.querySelector('[name="originalBarcode"]').value = itemData.barcode;
            form.querySelector('[name="productName"]').value = itemData.productName;
            form.querySelector('[name="productCode"]').value = itemData.productCode;
            form.querySelector('[name="Brand"]').value = itemData.brand;
            form.querySelector('[name="Category"]').value = itemData.category;
            form.querySelector('[name="Qty"]').value = itemData.qty;
            form.querySelector('[name="RRP"]').value = itemData.rrp;
            form.querySelector('[name="Price"]').value = itemData.price;
            form.querySelector('[name="Barcode"]').value = itemData.barcode;
            const currentImage = dialog.querySelector('#current-image-preview');
            currentImage.src = itemData.imageUrl || 'https://placehold.co/100x80/eee/ccc?text=No+Image';
            dialog.showModal();
        }
    </script>
</body>
</html>

